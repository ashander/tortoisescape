---
title: "SNP clinality"
date: "`r date()`"
---

```{r setup, include=FALSE}
library(pander)
library(phonTools)  # for fastacf
options(scipen=3)
fig.dim <- 5
knitr::opts_chunk$set(fig.height=fig.dim,fig.width=2*fig.dim,fig.align='center')
# locations and labels
tortdir <- gsub("tortoisescape.*","tortoisescape",getwd())
coord.obj <- load(file.path(tortdir,"tort_272_info","geog_coords.RData"))
coords <- get(coord.obj)
tort.ids <- row.names(coords)
nindivs <- length(tort.ids)
```

```{r snp_info, include=FALSE}
datadir <- "."
countfile <- file.path(datadir,"272torts_snp1e6_minmapq20minq30_map2kenro.counts.gz")
# maf <- read.table(file.path(datadir,"272torts_snp1e6_minmapq20minq30_map2kenro.mafs.gz"),header=TRUE)
pos <- read.table(file.path(datadir,"272torts_snp1e6_minmapq20minq30_map2kenro.pos.gz"),header=TRUE)
# scaffolds
minscaf <- 1e4  # minimum number of snps per scaffold
scaf.counts <- table( pos$chr )
long.scafs <- names(scaf.counts)[scaf.counts>=minscaf]
# apply filters
mindepth <- 150 # minimum totalDepth
maxdepth <- 350 # maximum totalDepth
goodones <- ( ( pos$totDepth >= mindepth ) & ( pos$totDepth <= maxdepth ) )
# minind <- 250   # minimum nInd -- RESULTS IN NO SNPs
# goodones <- goodones & ( maf$nInd >= minind )
goodones <- goodones & ( pos$chr %in% long.scafs )
```

```{r count_connection, include=FALSE}
countsuffix <- ".pc1counts.5bin"  # .5bin means binary, five columns
pccountfile <- gsub(".counts.gz",countsuffix,countfile)
pccountheaderfile <- paste0(pccountfile,".header")
pc.header <- scan(pccountheaderfile,what='char')
pc.con <- pipe(paste("cat",pccountfile), open="rb")
read_chunk <- function (blocksize) {
    # do this multiple times to read in chunks
    pc.counts <- readBin(pc.con,what="numeric",n=length(pc.header)*blocksize)
    dim(pc.counts) <- c(length(pc.header),length(pc.counts)/length(pc.header))
    pc.counts <- t(pc.counts)
    colnames(pc.counts) <- pc.header
    return(pc.counts)
}
umat <- read_chunk(nrow(pos))
close(pc.con)
```

# Data

We are only looking at scaffolds with at least `r minscaf` SNPs per scaffold,
and SNPs with total depth between `r mindepth` and `r maxdepth`;
this is a proportion `r mean(goodones)` of the SNPs.


# Computation

We want to compute the correlation and covariance of each site with a vector, $v$ (say, PC1).
If at a given site:

- $c(i) =$ major allele count in indiv $i$
- $n(i) =$ sample size, i.e. coverage of indiv $i$
- $p(i) =$ $c(i)/n(i)$
- $v(i) =$ vector of weights

then we need these things:

- $A = \sum_i p(i)$
- $B = \sum_i p(i) v(i)$
- $C = \sum_{i : p(i)>0} v(i)$
- $D = \sum_{i : p(i)>0} v(i)^2$
- $N = \#\{ i : n(i) > 0 \}$

Then, we estimate the covariance by
$$  ( B - A C / N ) / N $$
and the correlation by
$$
  ( \text{covariance} ) / \sqrt{ ( ( A - A^2 / N ) / (N-1) ) ( ( D - C^2 / N ) / (N-1) ) }
  = ( B N - A C ) (N-1) / N \sqrt{ ( A N - A^2 ) ( D N - C^2 ) }
$$

The five columns of `r pccountfile` are $A$, $B$, $C$, $D$, and $N$, respectively.

```{r convert_counts, include=FALSE}
# A is : sum_freq  
# B is : freq_prod 
# C is : sum_weights
# D is : sum_weights_sq
# N is : num_nonzero 
pc.num <- 1
pcs <- read.csv(file.path(tortdir,"tort_272_info","pcs.csv"),header=TRUE,stringsAsFactors=FALSE)
pcvec <- pcs[[paste0("PC",pc.num)]]
pcvec.mean <- umat[,"sum_weights"] / umat[,"num_nonzero"]
pcvec.var <- ( umat[,"sum_weights_sq"] - pcvec.mean * umat[,"sum_weights"] ) / (umat[,"num_nonzero"]-1) 
snp.freq <- umat[,"sum_freq"] / umat[,"num_nonzero"]
# snp.var <- snp.freq * ( 1 - snp.freq )
pc.cov <- ( umat[,"freq_prod"] / umat[,"num_nonzero"] - pcvec.mean * snp.freq )
pc.cor <- pc.cov / sqrt( snp.freq * ( 1 - snp.freq ) * pcvec.var )
```

Note that from these data we can also look for clinality in the **missing** data.
Suppose that

- $z(i) = 1$ if the allele is missing in individual $i$ and $=0$ otherwise;
- $C = \sum_i v(i) z(i)$
- $N = \sum_i z(i)$
- $n_I =$ the number of individuals
- $\bar v = \sum_i v(i) / n_I$
- $\sigma^2_v = \sum_i (v(i)-\bar v)^2 / (n_I-1)$

and so the covariance of $z$ with $v$ is
$$  ( C - N \sum_i v(i) / n_I ) / n_I $$
and the correlation is
$$  ( \text{covariance} ) / \sqrt{ ( N / n_I )( 1 - N/n_I ) \sigma^2_v } . $$

```{r na_cov, include=FALSE}
total.pc.mean <- mean(pcvec)
total.pc.var <- var(pcvec)
na.freq <- umat[,"num_nonzero"] / nindivs
na.cov <- ( umat[,"sum_weights"] / nindivs - total.pc.mean * na.freq )
na.cor <- na.cov / sqrt( na.freq * ( 1 - na.freq ) * total.pc.var )
```
```{r tidyup, include=FALSE}
# don't need umat any more
rm(umat); gc()
```

# Summary stats

Here is the histogram of minor allele frequencies,
with and without the filters above:
(recall that these were already selected by angsd as likely polymorphic)
```{r afs}
hist(1-snp.freq,breaks=1000, xlim=c(0,1), main="empirical minor allele frequency")
hist(1-snp.freq[goodones[seq_along(snp.freq)]],breaks=1000, xlim=c(0,1), main="same, on filtered sites")
```

And, here are the distributions of correlation coefficients:
```{r cor_hists}
hist(pc.cor,breaks=1000,xlim=c(-1,1), main="SNP correlations with PC1")
hist(pc.cor[goodones[seq_along(pc.cor)]],breaks=1000,xlim=c(-1,1), main="same, on filtered sites")
```

Here is correlation against minor allele frequency:
```{r cor_vs_freq, fig.width=fig.dim}
plot( snp.freq, pc.cor, pch='.', col=adjustcolor("black",0.5), main="SNPs",
        xlim=c(0,1), ylim=c(-1,1), xlab="frequency", ylab="correlation with PC1" )
```

And, frequencies of missingness, 
with the distribution expected if coverage is Poisson(1.2):
```{r na_afs}
xh <- hist(1-na.freq,breaks=1000, xlim=c(0,1), main="Frequency of missing data")
lines((0:nindivs)/nindivs, length(na.freq)*dbinom((0:nindivs),nindivs,exp(-1.2)),col='red',lwd=2)
xh <- hist(1-na.freq[goodones[seq_along(na.freq)]],breaks=1000, xlim=c(0,1), main="same, on filtered sites")
lines((0:nindivs)/nindivs, length(na.freq)*dbinom((0:nindivs),nindivs,exp(-1.2)),col='red',lwd=2)
```
and, distributions of correlation coefficients:
```{r cor_hists_na}
hist(na.cor,breaks=1000,xlim=c(-1,1), main="NA correlations with PC1")
hist(na.cor[goodones[seq_along(na.cor)]],breaks=1000,xlim=c(-1,1), main="same, on filtered sites")
```
and, correlation against minor allele frequency:
```{r na_cor_vs_freq, fig.width=fig.dim}
plot( snp.freq, pc.cor, pch='.', col=adjustcolor("black",0.5), main="missingness",
        xlim=c(0,1), ylim=c(-1,1), xlab="frequency", ylab="correlation with PC1" )
```

# By scaffold

First, let's look at the top ten longest scaffolds.
Red dots are sites removed by the filters.
```{r long_scafs}
superlong <- names(sort(scaf.counts,decreasing=TRUE)[1:10])
for (scaf in superlong) {
    plot( pos$pos[pos$chr==scaf], pc.cor[pos$chr==scaf],
            xlab='position', ylab='correlation', main=paste('scaffold',scaf),
            pch=ifelse(goodones[pos$chr==scaf],20,NA),
            col=adjustcolor(ifelse(goodones[pos$chr==scaf],'black','red'),0.25),
            ylim=c(-1,1) )
}
```
Huh, scaffold 2062 looks interesting.
What's the difference between the high and low correlation SNPs on that scaffold?
Those seem to line up with intermediate-frequency haplotypes:
```{r scaf_2062}
get_scaf <- function (scaf) {
    usethese <- (goodones & pos$chr==scaf)
    cbind( pos[usethese,], 
        data.frame( pc.cor=pc.cor[usethese],
                    snp.freq=snp.freq[usethese],
                    na.cor=na.cor[usethese],
                    na.freq=na.freq[usethese] ) )
}
this.scaf <- "scaffold_2062"
s2062 <- get_scaf(this.scaf)
cor( abs(s2062[,3:6]) )
# hist( s2062$pc.cor, breaks=60, main=paste('SNP correlations on',this.scaf) )
with( s2062, plot( pos, abs(pc.cor), pch=20, cex=0.5, xlab='position', 
                main=paste('SNP correlation,',this.scaf) ) )
with( s2062, plot( pos, snp.freq, pch=20, cex=0.5, xlab='position', 
                main=paste('SNP frequency',this.scaf) ) )
```


OK, let's see how correlations partition by scaffold.
```{r scaf_stats}
snp.by.scaf <- tapply( abs(pc.cor[goodones]), pos$chr[goodones], mean )
na.by.scaf <- tapply( abs(na.cor[goodones]), pos$chr[goodones], mean )
hist( snp.by.scaf, xlim=range(0,snp.by.scaf,na.by.scaf,finite=TRUE), breaks=50, 
        col=adjustcolor("blue",0.5), freq=TRUE, main='mean absolute correlation by scaffold' )
hist( na.by.scaf, breaks=50, add=TRUE, freq=TRUE, col=adjustcolor("red",0.5) )
legend("topleft", fill=c('blue','red'), legend=c('SNP', 'missingness'))
```
